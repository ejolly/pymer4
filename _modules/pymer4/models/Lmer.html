<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pymer4.models.Lmer &#8212; pymer4 0.8.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css?v=0bf093e7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=f9948e0f"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          Pymer4</a>
        <span class="navbar-text navbar-version pull-left"><b>0.8.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../auto_examples/index.html">Tutorial</a></li>
                <li><a href="../../../api.html">API</a></li>
                <li><a href="https://github.com/ejolly/pymer4">Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Nav <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../new.html">What's New</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rfx_cheatsheet.html">Lme4 RFX Cheatsheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citation.html">Citation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">TOC <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for pymer4.models.Lmer</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Pymer4 Lmer Class</span>
<span class="sd">=================</span>

<span class="sd">Main class to wrap R&#39;s lme4 library</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="kn">import</span> <span class="n">importr</span>
<span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="k">as</span> <span class="nn">robjects</span>
<span class="kn">from</span> <span class="nn">rpy2.rinterface_lib</span> <span class="kn">import</span> <span class="n">callbacks</span>
<span class="kn">import</span> <span class="nn">rpy2.rinterface</span> <span class="k">as</span> <span class="nn">rinterface</span>
<span class="kn">from</span> <span class="nn">rpy2.robjects.conversion</span> <span class="kn">import</span> <span class="n">localconverter</span>
<span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="kn">import</span> <span class="n">numpy2ri</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_sig_stars</span><span class="p">,</span>
    <span class="n">_perm_find</span><span class="p">,</span>
    <span class="n">_return_t</span><span class="p">,</span>
    <span class="n">_to_ranks_by_group</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..bridge</span> <span class="kn">import</span> <span class="n">con2R</span><span class="p">,</span> <span class="n">pandas2R</span><span class="p">,</span> <span class="n">R2pandas</span><span class="p">,</span> <span class="n">R2numpy</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">CategoricalDtype</span>

<span class="c1"># Import R libraries we need</span>
<span class="n">base</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">)</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s2">&quot;stats&quot;</span><span class="p">)</span>

<span class="c1"># Make a reference to the default R console writer from rpy2</span>
<span class="n">consolewrite_warning_backup</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">.</span><span class="n">consolewrite_warnerror</span>
<span class="n">consolewrite_print_backup</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">.</span><span class="n">consolewrite_print</span>


<div class="viewcode-block" id="Lmer"><a class="viewcode-back" href="../../../api.html#pymer4.models.Lmer">[docs]</a><span class="k">class</span> <span class="nc">Lmer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class to hold data outputted from fitting lmer in R and converting to Python object. This class stores as much information as it can about a merMod object computed using lmer and lmerTest in R. Most attributes will not be computed until the fit method is called.</span>

<span class="sd">    Args:</span>
<span class="sd">        formula (str): Complete lmer-style model formula</span>
<span class="sd">        data (pandas.core.frame.DataFrame): input data</span>
<span class="sd">        family (string): what distribution family (i.e.) link function to use for the generalized model; default is gaussian (linear model)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        fitted (bool): whether model has been fit</span>
<span class="sd">        formula (str): model formula</span>
<span class="sd">        data (pd.DataFrame): model copy of input data</span>
<span class="sd">        grps (dict): groups and number of observations per groups recognized by lmer</span>
<span class="sd">        design_matrix (pd.DataFrame): model design matrix determined by lmer</span>
<span class="sd">        AIC (float): model Akaike information criterion</span>
<span class="sd">        BIC (float): model Bayesian information criterion</span>
<span class="sd">        logLike (float): model Log-likelihood</span>
<span class="sd">        family (string): model family</span>
<span class="sd">        warnings (list): warnings output from R or Python</span>
<span class="sd">        ranef (pd.DataFrame/list): cluster-level differences from population parameters, i.e. difference between coefs and fixefs; returns list if multiple cluster variables are used to specify random effects (e.g. subjects and items)</span>
<span class="sd">        fixef (pd.DataFrame/list): cluster-level parameters; returns list if multiple cluster variables are used to specify random effects (e.g. subjects and items)</span>
<span class="sd">        coefs (pandas.core.frame.DataFrame/list): model summary table of population parameters</span>
<span class="sd">        ranef_var (pd.DataFrame): random effects variances</span>
<span class="sd">        ranef_corr(pd.DataFrame): random effects correlations</span>
<span class="sd">        residuals (numpy.ndarray): model residuals</span>
<span class="sd">        fits (numpy.ndarray): model fits/predictions</span>
<span class="sd">        model_obj (lmer model): rpy2 lmer model object</span>
<span class="sd">        factors (dict): factors used to fit the model if any</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span>
        <span class="n">implemented_fams</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
            <span class="s2">&quot;binomial&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gamma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;inverse_gaussian&quot;</span><span class="p">,</span>
            <span class="s2">&quot;poisson&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">implemented_fams</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Family must be one of: gaussian, binomial, gamma, inverse_gaussian or poisson!&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BIC</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contrast_codes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranked_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factors_prev_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contrasts</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(fitted = </span><span class="si">{}</span><span class="s2">, formula = </span><span class="si">{}</span><span class="s2">, family = </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_make_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor_dict</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covert specific columns to R-style factors. Default scheme is dummy coding where reference is 1st level provided. Alternative is orthogonal polynomial contrasts. User can also specific custom contrasts.</span>

<span class="sd">        Args:</span>
<span class="sd">            factor_dict: (dict) dictionary with column names specified as keys and values as a list for dummy/treatment/polynomial contrast; a dict with keys as factor leves and values as desired comparisons in human readable format</span>
<span class="sd">            ordered: (bool) whether to interpret factor_dict values as dummy-coded (1st list item is reference level) or as polynomial contrasts (linear contrast specified by ordered of list items); ignored if factor_dict values are not a list</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.core.frame.DataFrame: copy of original data with factorized columns</span>

<span class="sd">        Examples:</span>

<span class="sd">            Dummy/treatment contrasts with &#39;A&#39; as the reference level and other contrasts as &#39;B&#39;-&#39;A&#39; and &#39;C&#39;-&#39;A&#39;</span>

<span class="sd">            &gt;&gt;&gt; _make_factors(factor_dict={&#39;factor&#39;: [&#39;A&#39;,&#39;B&#39;,&#39;C&#39;]})</span>

<span class="sd">            Same as above but a linear contrast (and automatically computed quadratic contrast) of A &lt; B &lt; C</span>

<span class="sd">            &gt;&gt;&gt; _make_factors(factor_dict={&#39;factor&#39;: [&#39;A&#39;,&#39;B&#39;,&#39;C&#39;]}, ordered=True)</span>

<span class="sd">            Custom contrast of &#39;A&#39; - mean(&#39;B&#39;, &#39;C&#39;)</span>

<span class="sd">            &gt;&gt;&gt; _make_factors(factor_dict={&#39;factor&#39;: {&#39;A&#39;: 1, &#39;B&#39;: -0.5, &#39;C&#39;: -0.5}})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">errormsg</span> <span class="o">=</span> <span class="s2">&quot;factors should be specified as a dictionary with values as one of:</span><span class="se">\n</span><span class="s2">1) a list with factor levels in the desired order for dummy/treatment/polynomial contrasts</span><span class="se">\n</span><span class="s2">2) a dict with keys as factor levels and values as desired comparisons in human readable format&quot;</span>
        <span class="c1"># We create a copy of data because we need to convert dtypes to categories and then pass them to R. However, resetting categories on the *same* dataframe and passing to R repeatedly (e.g. multiple calls to .fit with different contrasats) does not work as R only uses the 1st category spec. So instead we create a copy and return that copy to get used by .fit</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">factor_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">errormsg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">contrasts</span> <span class="ow">in</span> <span class="n">factor_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># First convert to a string type because R needs string based categories</span>
            <span class="n">df</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

            <span class="c1"># Treatment/poly contrasts</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contrasts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># Ensure that all factor levels are accounted for</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">e</span> <span class="ow">in</span> <span class="n">contrasts</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Not all factor levels are specified in the desired contrast&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Define and apply a pandas categorical type in the same order as requested, which will get converted to the right factor levels in R</span>
                <span class="n">cat</span> <span class="o">=</span> <span class="n">CategoricalDtype</span><span class="p">(</span><span class="n">contrasts</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ordered</span><span class="p">:</span>
                    <span class="c1"># Polynomial contrasts</span>
                    <span class="n">con_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">contr_poly</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrasts</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Treatment/dummy contrasts</span>
                    <span class="n">con_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">contr_treatment</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrasts</span><span class="p">)))</span>

                <span class="n">out</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="n">con_codes</span>

            <span class="c1"># Custom contrasts (human readable)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contrasts</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">factor_levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">cons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="c1"># Ensure that all factor levels are accounted for</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">e</span> <span class="ow">in</span> <span class="n">factor_levels</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Not all factor levels are specified in the desired contrast&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Define and apply categorical type in the same order as requested</span>
                <span class="n">cat</span> <span class="o">=</span> <span class="n">CategoricalDtype</span><span class="p">(</span><span class="n">factor_levels</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
                <span class="c1"># Compute desired contrasts in R format along with addition k - 1 contrasts not specified</span>
                <span class="n">con_codes</span> <span class="o">=</span> <span class="n">con2R</span><span class="p">(</span><span class="n">cons</span><span class="p">)</span>
                <span class="n">out</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="n">con_codes</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">errormsg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="n">factor_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contrast_codes</span> <span class="o">=</span> <span class="n">out</span>
        <span class="c1"># have to do local convertion because dict values are numpy arrays :(</span>
        <span class="k">with</span> <span class="n">localconverter</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">default_converter</span> <span class="o">+</span> <span class="n">numpy2ri</span><span class="o">.</span><span class="n">converter</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">ListVector</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_refit_orthogonal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refit a model with factors organized as polynomial contrasts to ensure valid type-3 SS calculations with using `.anova()`. Previous factor specifications are stored in `model.factors_prev_`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">factors_prev_</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contrast_codes_prev_</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contrast_codes</span><span class="p">)</span>
        <span class="c1"># Create orthogonal polynomial contrasts for all factors, by creating a list of unique</span>
        <span class="c1"># factor levels as self._make_factors will handle the rest</span>
        <span class="n">new_factors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">new_factors</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">factors</span><span class="o">=</span><span class="n">new_factors</span><span class="p">,</span>
            <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">summarize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">permute</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_permute</span><span class="p">,</span>
            <span class="n">conf_int</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_conf_int</span><span class="p">,</span>
            <span class="n">REML</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_REML</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Lmer.anova"><a class="viewcode-back" href="../../../api.html#pymer4.models.Lmer.anova">[docs]</a>    <span class="k">def</span> <span class="nf">anova</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_orthogonal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a type-3 ANOVA table from a fitted model. Like R, this method does not ensure that contrasts are orthogonal to ensure correct type-3 SS computation. However, the force_orthogonal flag can refit the regression model with orthogonal polynomial contrasts automatically guaranteeing valid SS type 3 inferences. Note that this will overwrite factors specified in the last call to `.fit()`</span>

<span class="sd">        Args:</span>
<span class="sd">            force_orthogonal (bool): whether factors in the model should be recoded using polynomial contrasts to ensure valid type-3 SS calculations. If set to True, previous factor specifications will be saved in `model.factors_prev_`; default False</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: Type 3 ANOVA results</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
            <span class="c1"># Model can only have factors if it&#39;s been fit</span>
            <span class="k">if</span> <span class="n">force_orthogonal</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_refit_orthogonal</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fit before ANOVA table can be generated!&quot;</span><span class="p">)</span>

        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            df&lt;- anova(model)</span>
<span class="s2">            df</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">anova</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span> <span class="o">=</span> <span class="n">R2pandas</span><span class="p">(</span><span class="n">anova</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;SS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NumDF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DenomDF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;F-stat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="p">[</span><span class="s2">&quot;Sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="p">[</span><span class="s2">&quot;P-val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_sig_stars</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;MODELING FIT WARNING! Check model.warnings!! P-value computation did not occur because lmerTest choked. Possible issue(s): ranefx have too many parameters or too little variance...&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">,</span> <span class="s2">&quot;SS&quot;</span><span class="p">,</span> <span class="s2">&quot;MS&quot;</span><span class="p">,</span> <span class="s2">&quot;F-stat&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">force_orthogonal</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;SS Type III Analysis of Variance Table with Satterthwaite approximated degrees of freedom:</span><span class="se">\n</span><span class="s2">(NOTE: Model refit with orthogonal polynomial contrasts)&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;SS Type III Analysis of Variance Table with Satterthwaite approximated degrees of freedom:</span><span class="se">\n</span><span class="s2">(NOTE: Using original model contrasts, orthogonality not guaranteed)&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span></div>

    <span class="k">def</span> <span class="nf">_get_ngrps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unsum</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the groups information from the model as a dictionary&quot;&quot;&quot;</span>
        <span class="c1"># This works for 2 grouping factors</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;ngrps&quot;</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="s2">&quot;flist&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">ns</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_set_R_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adjust whether R prints to the console (often as a duplicate) based on the verbose flag of a method call. Reference to rpy2 interface here: https://bit.ly/2MsrufO&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="c1"># use the default logging in R</span>
            <span class="n">callbacks</span><span class="o">.</span><span class="n">consolewrite_warnerror</span> <span class="o">=</span> <span class="n">consolewrite_warning_backup</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create a list buffer to catch messages and discard them</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="n">callbacks</span><span class="o">.</span><span class="n">consolewrite_warnerror</span> <span class="o">=</span> <span class="n">_f</span>

<div class="viewcode-block" id="Lmer.fit"><a class="viewcode-back" href="../../../api.html#pymer4.models.Lmer.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">conf_int</span><span class="o">=</span><span class="s2">&quot;Wald&quot;</span><span class="p">,</span>
        <span class="n">n_boot</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">permute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">REML</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">rank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">rank_group</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">rank_exclude_cols</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">no_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">control</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">old_optimizer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main method for fitting model object. Will modify the model&#39;s data attribute to add columns for residuals and fits for convenience. Factors should be specified as a dictionary with values as a list or themselves a dictionary of *human readable* contrasts *not* R-style contrast codes as these will be auto-converted for you. See the factors docstring and examples below. After fitting, the .factors attribute will store a reference to the user-specified dictionary. The .contrast_codes model attributes will store the requested comparisons in converted R format. Note that Lmer estimate naming conventions differs a bit from R: Lmer.coefs = summary(model); Lmer.fixefs = coefs(model); Lmer.ranef = ranef(model)</span>

<span class="sd">        Args:</span>
<span class="sd">            conf_int (str): which method to compute confidence intervals; &#39;profile&#39;, &#39;Wald&#39; (default), or &#39;boot&#39; (parametric bootstrap)</span>
<span class="sd">            n_boot (int): number of bootstrap intervals if bootstrapped confidence intervals are requests; default 500</span>
<span class="sd">            factors (dict): dictionary with column names specified as keys and values as a list for dummy/treatment/polynomial contrast or a dict with keys as factor leves and values as desired comparisons in human readable format See examples below</span>
<span class="sd">            permute (int): if non-zero, computes parameter significance tests by permuting test stastics rather than parametrically. Permutation is done by shuffling observations within clusters to respect random effects structure of data.</span>
<span class="sd">            ordered (bool): whether factors should be treated as ordered polynomial contrasts; this will parameterize a model with K-1 orthogonal polynomial regressors beginning with a linear contrast based on the factor order provided. Ordering applies to **all** contrasts!; default is False</span>
<span class="sd">            summarize/summary (bool): whether to print a model summary after fitting; default is True</span>
<span class="sd">            verbose (bool): whether to print when and which model and confidence interval are being fitted</span>
<span class="sd">            REML (bool): whether to fit using restricted maximum likelihood estimation instead of maximum likelihood estimation; default True</span>
<span class="sd">            rank (bool): covert predictors in model formula to ranks by group prior to estimation. Model object will still contain original data not ranked data; default False</span>
<span class="sd">            rank_group (str): column name to group data on prior to rank conversion</span>
<span class="sd">            rank_exclude_cols (list/str): columns in model formula to not apply rank conversion to</span>
<span class="sd">            no_warnings (bool): turn off auto-printing warnings messages; warnings are always stored in the .warnings attribute; default False</span>
<span class="sd">            control (str): string containing options to be passed to (g)lmer control. See https://bit.ly/2OQONTH for options</span>
<span class="sd">            old_optimizer (bool): use the old bobyqa optimizer that was the default in lmer4 &lt;= 1.1_20, i.e. prior to 02/04/2019. This is not compatible with the control setting as it&#39;s meant to be a quick shorthand (e.g. to reproduce previous model results). However, the same setting can be manually requested using the control option if preferred. (For optimizer change discussions see: https://bit.ly/2MrP9Nq and https://bit.ly/2Vx5jte )</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: R/statsmodels style summary</span>

<span class="sd">        Examples:</span>
<span class="sd">            The following examples demonstrate how to treat variables as categorical factors.</span>

<span class="sd">            Dummy-Coding: Treat Col1 as a factor which 3 levels: A, B, C. Use dummy-coding with A as the reference level. Model intercept will be mean of A, and parameters will be B-A, and C-A.</span>

<span class="sd">            &gt;&gt;&gt; model.fit(factors = {&quot;Col1&quot;: [&#39;A&#39;,&#39;B&#39;,&#39;C&#39;]})</span>

<span class="sd">            Orthogonal Polynomials: Treat Col1 as a factor which 3 levels: A, B, C. Estimate a linear contrast of C &gt; B &gt; A. Model intercept will be grand-mean of all levels, and parameters will be linear contrast, and orthogonal polynomial contrast (auto-computed).</span>

<span class="sd">            &gt;&gt;&gt; model.fit(factors = {&quot;Col1&quot;: [&#39;A&#39;,&#39;B&#39;,&#39;C&#39;]}, ordered=True)</span>

<span class="sd">            Custom-contrast: Treat Col1 as a factor which 3 levels: A, B, C. Compare A to the mean of B and C. Model intercept will be the grand-mean of all levels, and parameters will be the desired contrast, a well as an automatically determined orthogonal contrast.</span>

<span class="sd">            &gt;&gt;&gt; model.fit(factors = {&quot;Col1&quot;: {&#39;A&#39;: 1, &#39;B&#39;: -.5, &#39;C&#39;: -.5}}))</span>

<span class="sd">            Here is an example specifying stricter deviance and paramter values stopping criteria.</span>

<span class="sd">            &gt;&gt;&gt; model.fit(control=&quot;optCtrl = list(ftol_abs=1e-8, xtol_abs=1e-8)&quot;)</span>

<span class="sd">            Here is an example specifying a different optimizer in addition to stricter deviance and paramter values stopping criteria.</span>

<span class="sd">            &gt;&gt;&gt; model.fit(control=&quot;optimizer=&#39;Nelder_Mead&#39;, optCtrl = list(FtolAbs=1e-8, XtolRel=1e-8)&quot;)</span>

<span class="sd">            Here is an example using the default optimization in previous versions of lme4 prior to the 2019 update.</span>

<span class="sd">            &gt;&gt;&gt; model.fit(old_optimizer=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Alllow summary or summarize for compatibility</span>
        <span class="k">if</span> <span class="s2">&quot;summary&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="s2">&quot;summarize&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;You specified both summary and summarize, please prefer summarize&quot;</span>
            <span class="p">)</span>
        <span class="n">summarize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;summarize&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">summarize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="n">summarize</span><span class="p">)</span>
        <span class="c1"># Save params for future calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_permute</span> <span class="o">=</span> <span class="n">permute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conf_int</span> <span class="o">=</span> <span class="n">conf_int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_REML</span> <span class="o">=</span> <span class="n">REML</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_R_stdout</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">permute</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;permute should &#39;False&#39; or the number of permutations to perform&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">old_optimizer</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">control</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Must specify EITHER control OR old_optimizer not both&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">control</span> <span class="o">=</span> <span class="s2">&quot;optimizer=&#39;bobyqa&#39;&quot;</span>
        <span class="k">if</span> <span class="n">factors</span><span class="p">:</span>
            <span class="n">contrasts</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_factors</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">ordered</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">contrasts</span> <span class="o">=</span> <span class="n">rinterface</span><span class="o">.</span><span class="n">NULL</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="k">if</span> <span class="n">rank</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rank_group</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rank_group must be provided if rank is True&quot;</span><span class="p">)</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">_to_ranks_by_group</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">rank_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">rank_exclude_cols</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">factors</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rank_exclude_cols</span><span class="p">)):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="s2">&quot;Factors and ranks requested, but factors are not excluded from rank conversion. Are you sure you wanted to do this?&quot;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;boot&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;bootstrapped&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;permutation&quot;</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">permute</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;parametric&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">pandas2R</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="n">_fam</span> <span class="o">=</span> <span class="s2">&quot;gaussian&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Fitting linear model using lmer with </span><span class="si">{</span><span class="n">conf_int</span><span class="si">}</span><span class="s2"> confidence intervals...</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">lmer</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s2">&quot;lmerTest&quot;</span><span class="p">)</span>
            <span class="n">lmc</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lmerControl(</span><span class="si">{</span><span class="n">control</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span> <span class="o">=</span> <span class="n">lmer</span><span class="o">.</span><span class="n">lmer</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">REML</span><span class="o">=</span><span class="n">REML</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="n">lmc</span><span class="p">,</span> <span class="n">contrasts</span><span class="o">=</span><span class="n">contrasts</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Fitting generalized linear model using glmer (family </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="si">}</span><span class="s2">) with </span><span class="si">{</span><span class="n">conf_int</span><span class="si">}</span><span class="s2"> confidence intervals...</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">lmer</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s2">&quot;lme4&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;inverse_gaussian&quot;</span><span class="p">:</span>
                <span class="n">_fam</span> <span class="o">=</span> <span class="s2">&quot;inverse.gaussian&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
                <span class="n">_fam</span> <span class="o">=</span> <span class="s2">&quot;Gamma&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span>
            <span class="n">lmc</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;glmerControl(</span><span class="si">{</span><span class="n">control</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span> <span class="o">=</span> <span class="n">lmer</span><span class="o">.</span><span class="n">glmer</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">family</span><span class="o">=</span><span class="n">_fam</span><span class="p">,</span>
                <span class="n">control</span><span class="o">=</span><span class="n">lmc</span><span class="p">,</span>
                <span class="n">contrasts</span><span class="o">=</span><span class="n">contrasts</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Store design matrix and get number of IVs for inference</span>
        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="c1"># rpy2 &gt; 3.4 returns a numpy array that can be empty but has shape (obs x IVs)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
                <span class="n">num_IV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_IV</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># rpy2 &lt; 3.4 returns an R matrix object with a length</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="n">R2pandas</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">data_frame</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">))</span>
            <span class="n">num_IV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_IV</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">permute</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using </span><span class="si">{}</span><span class="s2"> permutations to determine significance...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">permute</span><span class="p">))</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="n">unsum</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">unclass</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

        <span class="c1"># Do scalars first cause they&#39;re easier</span>

        <span class="c1"># Get group names separately cause rpy2 &gt; 2.9 is weird and doesnt return them above</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_ngrps</span><span class="p">(</span><span class="n">unsum</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;The rpy2, lme4, or lmerTest API appears to have changed again. Please file a bug report at https://github.com/ejolly/pymer4/issues with your R, Python, rpy2, lme4, and lmerTest versions and the OS you&#39;re running pymer4 on. Apologies.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># self.AIC = unsum.rx2(&quot;AICtab&quot;)[0]</span>
        <span class="c1"># the above is incorrect. The AICtab of summary.lmerMod gives the deviance (which in this context is really</span>
        <span class="c1"># -2 LogLik, NOT the AIC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span> <span class="o">=</span> <span class="n">R2numpy</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">AIC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BIC</span> <span class="o">=</span> <span class="n">R2numpy</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">BIC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span> <span class="o">=</span> <span class="n">R2numpy</span><span class="p">(</span><span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;logLik&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># First check for lme4 printed messages (e.g. convergence info is usually here instead of in warnings)</span>
        <span class="n">fit_messages</span> <span class="o">=</span> <span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;optinfo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;conv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;lme4&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">)</span>
        <span class="c1"># Then check warnings for additional stuff</span>
        <span class="n">fit_warnings</span> <span class="o">=</span> <span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;optinfo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;warnings&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fit_warnings</span> <span class="o">=</span> <span class="p">[</span><span class="n">fw</span> <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">fit_warnings</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">fit_warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fit_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">fit_messages</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">fit_messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">fit_messages_warnings</span> <span class="o">=</span> <span class="n">fit_warnings</span> <span class="o">+</span> <span class="n">fit_messages</span>
        <span class="k">if</span> <span class="n">fit_messages_warnings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fit_messages_warnings</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_warnings</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">warning</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">|</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">warning</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">warning</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">warning</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Coefficients, and inference statistics</span>
        <span class="k">if</span> <span class="n">num_IV</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;inverse_gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;poisson&quot;</span><span class="p">]:</span>

                <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    function(model){</span>
<span class="sd">                    out.coef &lt;- data.frame(unclass(summary(model))$coefficients)</span>
<span class="sd">                    out.ci &lt;- data.frame(confint(model,method=&#39;&quot;&quot;&quot;</span>
                    <span class="o">+</span> <span class="n">conf_int</span>
                    <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,nsim=&quot;&quot;&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_boot</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;&quot;&quot;))</span>
<span class="s2">                    n &lt;- c(rownames(out.ci))</span>
<span class="s2">                    idx &lt;- max(grep(&#39;sig&#39;,n))</span>
<span class="s2">                    out.ci &lt;- out.ci[-seq(1:idx),]</span>
<span class="s2">                    out &lt;- cbind(out.coef,out.ci)</span>
<span class="s2">                    list(out,rownames(out))</span>
<span class="s2">                    }</span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="p">)</span>
                <span class="n">estimates_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
                <span class="n">out_summary</span><span class="p">,</span> <span class="n">out_rownames</span> <span class="o">=</span> <span class="n">estimates_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">R2pandas</span><span class="p">(</span><span class="n">out_summary</span><span class="p">)</span>
                <span class="n">dfshape</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_rownames</span><span class="p">)</span>

                <span class="c1"># gaussian</span>
                <span class="k">if</span> <span class="n">dfshape</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
                        <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;DF&quot;</span><span class="p">,</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">]</span>
                    <span class="p">]</span>

                <span class="c1"># gamma, inverse_gaussian</span>
                <span class="k">elif</span> <span class="n">dfshape</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;inverse_gaussian&quot;</span><span class="p">]:</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                        <span class="p">]</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
                            <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">]</span>
                        <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># poisson</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Z-stat&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                        <span class="p">]</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
                            <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;Z-stat&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">]</span>
                        <span class="p">]</span>

                <span class="c1"># Incase lmerTest chokes it won&#39;t return p-values</span>
                <span class="k">elif</span> <span class="n">dfshape</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">permute</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s2">&quot;MODELING FIT WARNING! Check model.warnings!! P-value computation did not occur because lmerTest choked. Possible issue(s): ranefx have too many parameters or too little variance...&quot;</span>
                        <span class="p">)</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">]</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">]]</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;binomial&quot;</span><span class="p">:</span>

                <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    function(model){</span>
<span class="sd">                    out.coef &lt;- data.frame(unclass(summary(model))$coefficients)</span>
<span class="sd">                    out.ci &lt;- data.frame(confint(model,method=&#39;&quot;&quot;&quot;</span>
                    <span class="o">+</span> <span class="n">conf_int</span>
                    <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,nsim=&quot;&quot;&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_boot</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;&quot;&quot;))</span>
<span class="s2">                    n &lt;- c(rownames(out.ci))</span>
<span class="s2">                    idx &lt;- max(grep(&#39;sig&#39;,n))</span>
<span class="s2">                    out.ci &lt;- out.ci[-seq(1:idx),]</span>
<span class="s2">                    out &lt;- cbind(out.coef,out.ci)</span>
<span class="s2">                    odds &lt;- exp(out.coef[1])</span>
<span class="s2">                    colnames(odds) &lt;- &quot;OR&quot;</span>
<span class="s2">                    probs &lt;- odds / (1 + odds)</span>
<span class="s2">                    colnames(probs) &lt;- &quot;Prob&quot;</span>
<span class="s2">                    odds.ci &lt;- exp(out.ci)</span>
<span class="s2">                    colnames(odds.ci) &lt;- c(&quot;OR_2.5_ci&quot;,&quot;OR_97.5_ci&quot;)</span>
<span class="s2">                    probs.ci &lt;- odds.ci / (1 + odds.ci)</span>
<span class="s2">                    if(ncol(probs.ci) == 1){</span>
<span class="s2">                      probs.ci = t(probs.ci)</span>
<span class="s2">                    }</span>
<span class="s2">                    colnames(probs.ci) &lt;- c(&quot;Prob_2.5_ci&quot;,&quot;Prob_97.5_ci&quot;)</span>
<span class="s2">                    out &lt;- cbind(out,odds,odds.ci,probs,probs.ci)</span>
<span class="s2">                    list(out,rownames(out))</span>
<span class="s2">                    }</span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="p">)</span>

                <span class="n">estimates_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
                <span class="n">out_summary</span><span class="p">,</span> <span class="n">out_rownames</span> <span class="o">=</span> <span class="n">estimates_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">R2pandas</span><span class="p">(</span><span class="n">out_summary</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_rownames</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Z-stat&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;OR&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;OR_2.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;OR_97.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Prob&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Prob_2.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Prob_97.5_ci&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OR&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OR_2.5_ci&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OR_97.5_ci&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Prob&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Prob_2.5_ci&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Prob_97.5_ci&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Z-stat&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">]</span>

            <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
                <span class="n">perm_dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">dv_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">grp_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grps</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">perms</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">permute</span><span class="p">):</span>
                    <span class="n">perm_dat</span><span class="p">[</span><span class="n">dv_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm_dat</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grp_vars</span><span class="p">)[</span><span class="n">dv_var</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                        <span class="n">perm_obj</span> <span class="o">=</span> <span class="n">lmer</span><span class="o">.</span><span class="n">lmer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">perm_dat</span><span class="p">,</span> <span class="n">REML</span><span class="o">=</span><span class="n">REML</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">perm_obj</span> <span class="o">=</span> <span class="n">lmer</span><span class="o">.</span><span class="n">glmer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">perm_dat</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">_fam</span><span class="p">)</span>
                    <span class="n">perms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_return_t</span><span class="p">(</span><span class="n">perm_obj</span><span class="p">))</span>
                <span class="n">perms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">perms</span><span class="p">)</span>
                <span class="n">pvals</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;inverse_gaussian&quot;</span><span class="p">]:</span>
                        <span class="n">pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_perm_find</span><span class="p">(</span><span class="n">perms</span><span class="p">[:,</span> <span class="n">c</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;T-stat&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_perm_find</span><span class="p">(</span><span class="n">perms</span><span class="p">[:,</span> <span class="n">c</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Z-stat&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">]))</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;P-val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvals</span>
                <span class="k">if</span> <span class="s2">&quot;DF&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">permute</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;DF&quot;</span><span class="p">:</span> <span class="s2">&quot;Num_perm&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">:</span> <span class="s2">&quot;Perm-P-val&quot;</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Num_perm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">permute</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;P-val&quot;</span><span class="p">:</span> <span class="s2">&quot;Perm-P-val&quot;</span><span class="p">})</span>

            <span class="k">if</span> <span class="s2">&quot;P-val&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Sig</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;P-val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_sig_stars</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="s2">&quot;Perm-P-val&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Sig</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Perm-P-val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_sig_stars</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;boot&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">permute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># We&#39;re computing parametrically bootstrapped ci&#39;s so it doesn&#39;t make sense to use approximation for p-values. Instead remove those from the output and make significant inferences based on whether the bootstrapped ci&#39;s cross 0.</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;P-val&quot;</span><span class="p">,</span> <span class="s2">&quot;Sig&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s2">&quot;DF&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;DF&quot;</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;2.5_ci&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;97.5_ci&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Because all models except lmm have no DF column make sure Num_perm gets put in the right place</span>
            <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">!=</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">col_order</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Num_perm&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_order</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="n">df</span>
            <span class="c1"># Make sure the design matrix column names match population coefficients</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">permute</span> <span class="ow">or</span> <span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;boot&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;**NOTE**: Non-parametric inference only applies to fixed effects and none were estimated</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Random effect variances and correlations</span>
        <span class="n">varcor_NAs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="n">robjects</span><span class="o">.</span><span class="n">NA_Character</span><span class="p">]</span>  <span class="c1"># NOQA</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">R2pandas</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">data_frame</span><span class="p">(</span><span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;varcor&quot;</span><span class="p">)))</span>
        <span class="n">ran_vars</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;var2 in @varcor_NAs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;var2&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ran_vars</span><span class="p">[</span><span class="s2">&quot;grp&quot;</span><span class="p">]</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;grp&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Var&quot;</span><span class="p">,</span> <span class="s2">&quot;Std&quot;</span><span class="p">]</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ran_vars</span> <span class="o">=</span> <span class="n">ran_vars</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">robjects</span><span class="o">.</span><span class="n">NA_Character</span> <span class="k">else</span> <span class="n">x</span>
        <span class="p">)</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ran_corrs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;var2 not in @varcor_NAs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;vcov&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ran_corrs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ran_corrs</span><span class="p">[</span><span class="s2">&quot;grp&quot;</span><span class="p">]</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;grp&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;IV1&quot;</span><span class="p">,</span> <span class="s2">&quot;IV2&quot;</span><span class="p">,</span> <span class="s2">&quot;Corr&quot;</span><span class="p">]</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ran_corrs</span> <span class="o">=</span> <span class="n">ran_corrs</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">robjects</span><span class="o">.</span><span class="n">NA_Character</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ran_corrs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_var</span> <span class="o">=</span> <span class="n">ran_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span> <span class="o">=</span> <span class="n">ran_corrs</span>

        <span class="c1"># Cluster (e.g subject) level coefficients</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            getIndex &lt;- function(df){</span>
<span class="s2">                    orignames &lt;- names(df)</span>
<span class="s2">                    df &lt;- transform(df, index=row.names(df))</span>
<span class="s2">                    names(df) &lt;- append(orignames, c(&quot;index&quot;))</span>
<span class="s2">                    df</span>
<span class="s2">                    }</span>
<span class="s2">            out &lt;- coef(model)</span>
<span class="s2">            out &lt;- lapply(out, getIndex)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">fixef_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">fixefs</span> <span class="o">=</span> <span class="n">fixef_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="n">fixefs</span> <span class="o">=</span> <span class="p">[</span><span class="n">R2pandas</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">fixefs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixefs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f_corrected_order</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fixefs</span><span class="p">:</span>
                    <span class="n">f_corrected_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                            <span class="n">f</span><span class="p">[</span>
                                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                                <span class="o">+</span> <span class="p">[</span>
                                    <span class="n">elem</span>
                                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">columns</span>
                                    <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span>
                                <span class="p">]</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="n">f_corrected_order</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixefs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="n">fixefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="p">[</span>
                    <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="o">+</span> <span class="p">[</span>
                        <span class="n">elem</span>
                        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="o">.</span><span class="n">columns</span>
                        <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span>
                    <span class="p">]</span>
                <span class="p">]</span>

        <span class="c1"># Sort column order to match population coefs</span>
        <span class="c1"># This also handles cases in which random slope terms exist in the model without corresponding fixed effects terms, which generates extra columns in this dataframe. By default put those columns *after* the fixed effect columns of interest (i.e. population coefs)</span>

        <span class="c1"># Cluster (e.g subject) level random deviations</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            uniquify &lt;- function(df){</span>
<span class="s2">            colnames(df) &lt;- make.unique(colnames(df))</span>
<span class="s2">            df</span>
<span class="s2">            }</span>
<span class="s2">            getIndex &lt;- function(df){</span>
<span class="s2">            df &lt;- transform(df, index=row.names(df))</span>
<span class="s2">            df</span>
<span class="s2">            }</span>
<span class="s2">            out &lt;- lapply(ranef(model),uniquify)</span>
<span class="s2">            out &lt;- lapply(out, getIndex)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">ranef_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">ranefs</span> <span class="o">=</span> <span class="n">ranef_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranefs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranef</span> <span class="o">=</span> <span class="p">[</span><span class="n">R2pandas</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ranefs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranef</span> <span class="o">=</span> <span class="n">R2pandas</span><span class="p">(</span><span class="n">ranefs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>

        <span class="c1"># Model residuals</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            out &lt;- resid(model)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">resid_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resid_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>  <span class="c1"># NOQA</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;**NOTE**: Column for &#39;residuals&#39; not created in model.data, but saved in model.resid only. This is because you have rows with NaNs in your data.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Model fits</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            out &lt;- fitted(model)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">fit_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits</span> <span class="o">=</span> <span class="n">fit_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>  <span class="c1"># NOQA</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;**NOTE** Column for &#39;fits&#39; not created in model.data, but saved in model.fits only. This is because you have rows with NaNs in your data.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">summarize</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span></div>

<div class="viewcode-block" id="Lmer.simulate"><a class="viewcode-back" href="../../../api.html#pymer4.models.Lmer.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_datasets</span><span class="p">,</span> <span class="n">use_rfx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate new responses based upon estimates from a fitted model. By default group/cluster means for simulated data will match those of the original data. Unlike predict, this is a non-deterministic operation because lmer will sample random-efects values for all groups/cluster and then sample data points from their respective conditional distributions.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_datasets (int): number of simulated datasets to generate. Each simulation always generates a dataset that matches the size of the original data</span>
<span class="sd">            use_rfx (bool): wehther to match group/cluster means in simulated data</span>
<span class="sd">            verbose (bool): whether to print R messages to console</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: simulated data values</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_R_stdout</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">num_datasets</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_datasets must be an integer&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_rfx</span><span class="p">:</span>
            <span class="n">re_form</span> <span class="o">=</span> <span class="s2">&quot;NULL&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">re_form</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>

        <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            function(model){</span>
<span class="sd">            out &lt;- simulate(model,&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,allow.new.levels=TRUE,re.form=&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="n">re_form</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">simulate_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">sims</span> <span class="o">=</span> <span class="n">simulate_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">R2pandas</span><span class="p">(</span><span class="n">sims</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Lmer.predict"><a class="viewcode-back" href="../../../api.html#pymer4.models.Lmer.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">use_rfx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">pred_type</span><span class="o">=</span><span class="s2">&quot;response&quot;</span><span class="p">,</span>
        <span class="n">skip_data_checks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">verify_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make predictions given new data. Input must be a dataframe that contains the</span>
<span class="sd">        same columns as the model.matrix excluding the intercept (i.e. all the predictor</span>
<span class="sd">        variables used to fit the model). If using random effects to make predictions,</span>
<span class="sd">        input data must also contain a column for the group identifier that were used to</span>
<span class="sd">        fit the model random effects terms. Using random effects to make predictions</span>
<span class="sd">        only makes sense if predictions are being made about the same groups/clusters.</span>
<span class="sd">        If any predictors are categorical, you can skip verifying column names by</span>
<span class="sd">        setting `skip_data_checks=True`.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (pandas.core.frame.DataFrame): input data to make predictions on</span>
<span class="sd">            use_rfx (bool): whether to condition on random effects when making</span>
<span class="sd">            predictions; Default True</span>
<span class="sd">            pred_type (str): whether the prediction should be on the &#39;response&#39; scale</span>
<span class="sd">            (default); or on the &#39;link&#39; scale of the predictors passed through the link</span>
<span class="sd">            function (e.g. log-odds scale in a logit model instead of probability</span>
<span class="sd">            values)</span>
<span class="sd">            skip_data_checks (bool): whether to skip checks that input data have the</span>
<span class="sd">            same columns as the original data the model were trained on. If predicting</span>
<span class="sd">            using a model trained with categorical variables it can be helpful to set</span>
<span class="sd">            this to False. Default True</span>
<span class="sd">            verify_predictions (bool): whether to ensure that the predicted data are not</span>
<span class="sd">            identical to original model fits. Only useful to set this to False when</span>
<span class="sd">            making predictions on the same data the model was fit on, but its faster to</span>
<span class="sd">            access these directly from model.fits or model.data[&#39;fits&#39;]. Default True</span>
<span class="sd">            verbose (bool): whether to print R messages to console</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: prediction values</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_R_stdout</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No fixed effects were estimated so prediction is not possible!&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_data_checks</span><span class="p">:</span>
            <span class="n">required_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Column names do not match all fixed effects model terms!</span><span class="se">\n</span><span class="s2">This may be a false error if some predictors are categorical, in which case you can bypass this check by setting skip_data_checks=True.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">use_rfx</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_data_checks</span><span class="p">:</span>
                <span class="n">required_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">required_cols</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grps</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Column names are missing random effects model grouping terms!&quot;</span>
                    <span class="p">)</span>

            <span class="n">re_form</span> <span class="o">=</span> <span class="s2">&quot;NULL&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">re_form</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>

        <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            function(model,new){</span>
<span class="sd">            out &lt;- predict(model,new,allow.new.levels=TRUE,re.form=&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="n">re_form</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,type=&#39;&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="n">pred_type</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">predict_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">predict_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">,</span> <span class="n">pandas2R</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verify_predictions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_preds</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">use_rfx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">preds</span></div>

    <span class="k">def</span> <span class="nf">_verify_preds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">use_rfx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the output of .predict given new data is not identitical to the</span>
<span class="sd">        model&#39;s fits from the data it was trained on. This is necessary because</span>
<span class="sd">        `predict()` in R will silently fallback to return the same predicted values when</span>
<span class="sd">        given input data with no matching columns, but with `use_rfx=False`</span>

<span class="sd">        Args:</span>
<span class="sd">            preds (np.array): output of self.predict()</span>
<span class="sd">            use_rfx (bool): same input parameter as self.predict</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If predictions match model fits from original data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">training_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">use_rfx</span><span class="o">=</span><span class="n">use_rfx</span><span class="p">,</span> <span class="n">skip_data_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verify_predictions</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">mess</span> <span class="o">=</span> <span class="s2">&quot;(using rfx)&quot;</span> <span class="k">if</span> <span class="n">use_rfx</span> <span class="k">else</span> <span class="s2">&quot;(without rfx)&quot;</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">training_preds</span><span class="p">,</span> <span class="n">preds</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Predictions are identitical to fitted values </span><span class="si">{</span><span class="n">mess</span><span class="si">}</span><span class="s2">!!</span><span class="se">\n</span><span class="s2">You can ignore this error if you intended to predict using the same data the model was trained on by setting verify_predictions=False. If you didn&#39;t, then its likely that some or all of the column names in your test data don&#39;t match the column names from the data the model was trained on and you set skip_data_checks=True.&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Lmer.summary"><a class="viewcode-back" href="../../../api.html#pymer4.models.Lmer.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize the output of a fitted model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: R/statsmodels style summary</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted to generate summary!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_REML</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear mixed model fit by REML [’lmerMod’]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear mixed model fit by maximum likelihood  [&#39;lmerMod&#39;]&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Formula: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Family: </span><span class="si">{}</span><span class="se">\t</span><span class="s2"> Inference: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Number of observations: </span><span class="si">%s</span><span class="se">\t</span><span class="s2"> Groups: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">grps</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Log-likelihood: </span><span class="si">%.3f</span><span class="s2"> </span><span class="se">\t</span><span class="s2"> AIC: </span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Random effects:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ranef_var</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No random effect correlations specified</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No fixed effects estimated</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fixed effects:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lmer.post_hoc"><a class="viewcode-back" href="../../../api.html#pymer4.models.Lmer.post_hoc">[docs]</a>    <span class="k">def</span> <span class="nf">post_hoc</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">marginal_vars</span><span class="p">,</span>
        <span class="n">grouping_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">p_adjust</span><span class="o">=</span><span class="s2">&quot;tukey&quot;</span><span class="p">,</span>
        <span class="n">summarize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dof_asymptotic_at</span><span class="o">=</span><span class="mi">99999</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Post-hoc pair-wise tests corrected for multiple comparisons (Tukey method) implemented using the emmeans package. This method provide both marginal means/trends along with marginal pairwise differences. More info can be found at: https://cran.r-project.org/web/packages/emmeans/emmeans.pdf</span>

<span class="sd">        Args:</span>
<span class="sd">            marginal_var (str/list): what variable(s) to compute marginal means/trends for; unique combinations of factor levels of these variable(s) will determine family-wise error correction</span>
<span class="sd">            grouping_vars (str/list): what variable(s) to group on. Trends/means/comparisons of other variable(s), will be computed at each level of these variable(s)</span>
<span class="sd">            p_adjust (str): multiple comparisons adjustment method. One of: tukey, bonf, fdr, hochberg, hommel, holm, dunnet, mvt (monte-carlo multi-variate T, aka exact tukey/dunnet). Default tukey</span>
<span class="sd">            summarize (bool): output effects and contrasts or don&#39;t (always stored in</span>
<span class="sd">            model object as model.marginal_estimates and model.marginal_contrasts);</span>
<span class="sd">            default True</span>
<span class="sd">            dof_asymptotic_at (int, optional): at what number of observations to</span>
<span class="sd">            assuming a normal distribution and return z-stats instead of t-stats;</span>
<span class="sd">            Default 100000 which differs from emmeans default of 3000</span>
<span class="sd">            verbose (bool): whether to print R messages to the console</span>

<span class="sd">        Returns:</span>
<span class="sd">            Multiple:</span>
<span class="sd">                - **marginal_estimates** (*pd.Dataframe*): unique factor level effects (e.g. means/coefs)</span>

<span class="sd">                - **marginal_contrasts** (*pd.DataFrame*): contrasts between factor levels</span>

<span class="sd">        Examples:</span>

<span class="sd">            Pairwise comparison of means of A at each level of B</span>

<span class="sd">            &gt;&gt;&gt; model.post_hoc(marginal_vars=&#39;A&#39;,grouping_vars=&#39;B&#39;)</span>

<span class="sd">            Pairwise differences of slopes of C between levels of A at each level of B</span>

<span class="sd">            &gt;&gt;&gt; model.post_hoc(marginal_vars=&#39;C&#39;,grouping_vars=[&#39;A&#39;,&#39;B&#39;])</span>

<span class="sd">            Pairwise differences of each unique A,B cell</span>

<span class="sd">            &gt;&gt;&gt; model.post_hoc(marginal_vars=[&#39;A&#39;,&#39;B&#39;])</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_R_stdout</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">marginal_vars</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide marginal_vars&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted to generate post-hoc comparisons&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dof_asymptotic_at</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of observations </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> exceeds dof_symptotic_at=</span><span class="si">{</span><span class="n">dof_asymptotic_at</span><span class="si">}</span><span class="s2">. Returning z-stats&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">marginal_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">marginal_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">marginal_vars</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">p_adjust</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p_adjust</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>

        <span class="k">if</span> <span class="n">grouping_vars</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grouping_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">grouping_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">grouping_vars</span><span class="p">]</span>
            <span class="c1"># Conditional vars can only be factor types</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">grouping_vars</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;All grouping_vars must be existing categorical variables (i.e. factors)&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Need to figure out if marginal_vars is continuous or not to determine lstrends or emmeans call</span>
        <span class="n">cont</span><span class="p">,</span> <span class="n">factor</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">marginal_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="ow">or</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">cont</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">factor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">factor</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;With more than one marginal variable, all variables must be categorical factors. Mixing continuous and categorical variables is not supported. Try passing additional categorical factors to grouping_vars&quot;</span>
                    <span class="s2">&quot;&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Marginal variables can only contain one continuous variable&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">grouping_vars</span><span class="p">:</span>
                        <span class="c1"># Emtrends; there&#39;s a bug for trends where options don&#39;t get set by default so an empty list is passed to R, see: https://bit.ly/2VJ9QZM</span>
                        <span class="n">cont</span> <span class="o">=</span> <span class="n">cont</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grouping_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">g1</span> <span class="o">=</span> <span class="n">grouping_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">_conditional</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grouping_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

                            <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">                                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                function(model){</span>
<span class="sd">                                suppressMessages(library(emmeans))</span>
<span class="sd">                                out &lt;- emtrends(model,pairwise ~ &quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">g1</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;|&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">_conditional</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,var=&#39;&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">cont</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,adjust=&#39;&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">p_adjust</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,options=list(),lmer.df=&#39;satterthwaite&#39;,lmerTest.limit=&#39;&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dof_asymptotic_at</span><span class="p">)</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;)</span>
<span class="s2">                                out</span>
<span class="s2">                                }&quot;&quot;&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">                                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                function(model){</span>
<span class="sd">                                suppressMessages(library(emmeans))</span>
<span class="sd">                                out &lt;- emtrends(model,pairwise ~ &quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">grouping_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,var=&#39;&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">cont</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,adjust=&#39;&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">p_adjust</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,options=list(),lmer.df=&#39;satterthwaite&#39;,lmerTest.limit=&#39;&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dof_asymptotic_at</span><span class="p">)</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;)</span>
<span class="s2">                                out</span>
<span class="s2">                                }&quot;&quot;&quot;</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;grouping_vars are required with a continuous marginal_vars&quot;</span>
                        <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">factor</span><span class="p">:</span>
                <span class="n">_marginal</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">grouping_vars</span><span class="p">:</span>
                    <span class="c1"># emmeans with pipe</span>
                    <span class="n">_conditional</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grouping_vars</span><span class="p">)</span>
                    <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        function(model){</span>
<span class="sd">                        suppressMessages(library(emmeans))</span>
<span class="sd">                        out &lt;- emmeans(model,pairwise ~ &quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="n">_marginal</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;|&quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="n">_conditional</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;, adjust=&#39;&quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="n">p_adjust</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,lmer.df=&#39;satterthwaite&#39;,lmerTest.limit=&#39;&quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dof_asymptotic_at</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;)</span>
<span class="s2">                        out</span>
<span class="s2">                        }&quot;&quot;&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># emmeans without pipe</span>
                    <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        function(model){</span>
<span class="sd">                        suppressMessages(library(emmeans))</span>
<span class="sd">                        out &lt;- emmeans(model,pairwise ~ &quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="n">_marginal</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,adjust=&#39;&quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="n">p_adjust</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,lmer.df=&#39;satterthwaite&#39;,lmerTest.limit=&#39;&quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dof_asymptotic_at</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;)</span>
<span class="s2">                        out</span>
<span class="s2">                        }&quot;&quot;&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;marginal_vars are not in model!&quot;</span><span class="p">)</span>

        <span class="n">func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="n">emmeans</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s2">&quot;emmeans&quot;</span><span class="p">)</span>

        <span class="c1"># Marginal estimates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span> <span class="o">=</span> <span class="n">R2pandas</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Resort columns</span>
        <span class="n">effect_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
        <span class="c1"># this column name changes depending on whether we&#39;re doing post-hoc trends or means</span>
        <span class="n">effname</span> <span class="o">=</span> <span class="n">effect_names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sortme</span> <span class="o">=</span> <span class="n">effect_names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;DF&quot;</span><span class="p">]</span>

        <span class="c1"># In emmeans (compared to lsmeans) the CI column names change too depending on how many factor variabls are in the model</span>
        <span class="k">if</span> <span class="s2">&quot;asymp.LCL&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="n">effname</span><span class="p">:</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;asymp.LCL&quot;</span><span class="p">:</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;asymp.UCL&quot;</span><span class="p">:</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)[</span><span class="n">sortme</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;lower.CL&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="n">effname</span><span class="p">:</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;lower.CL&quot;</span><span class="p">:</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;upper.CL&quot;</span><span class="p">:</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)[</span><span class="n">sortme</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot figure out what emmeans is naming marginal CI columns. Expected &#39;lower.CL&#39; or &#39;asymp.LCL&#39;, but columns are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Marginal Contrasts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span> <span class="o">=</span> <span class="n">R2pandas</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;t.ratio&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;t.ratio&quot;</span><span class="p">:</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;p.value&quot;</span><span class="p">:</span> <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                <span class="s2">&quot;estimate&quot;</span><span class="p">:</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;contrast&quot;</span><span class="p">:</span> <span class="s2">&quot;Contrast&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">sorted_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;z.ratio&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;z.ratio&quot;</span><span class="p">:</span> <span class="s2">&quot;Z-stat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;p.value&quot;</span><span class="p">:</span> <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                <span class="s2">&quot;estimate&quot;</span><span class="p">:</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;contrast&quot;</span><span class="p">:</span> <span class="s2">&quot;Contrast&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">sorted_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Z-stat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot figure out what emmeans is naming contrast means columns. Expected &#39;t.ratio&#39; or &#39;z.ratio&#39;, but columns are: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>

        <span class="c1"># Need to make another call to emmeans to get confidence intervals on contrasts</span>
        <span class="n">confs</span> <span class="o">=</span> <span class="n">R2pandas</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">unclass</span><span class="p">(</span><span class="n">emmeans</span><span class="o">.</span><span class="n">confint_emmGrid</span><span class="p">(</span><span class="n">res</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">confs</span> <span class="o">=</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="c1"># Deal with changing column names again</span>
        <span class="k">if</span> <span class="s2">&quot;asymp.LCL&quot;</span> <span class="ow">in</span> <span class="n">confs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">confs</span> <span class="o">=</span> <span class="n">confs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;asymp.LCL&quot;</span><span class="p">:</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;asymp.UCL&quot;</span><span class="p">:</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;lower.CL&quot;</span> <span class="ow">in</span> <span class="n">confs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">confs</span> <span class="o">=</span> <span class="n">confs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lower.CL&quot;</span><span class="p">:</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;upper.CL&quot;</span><span class="p">:</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot figure out what emmeans is naming contrast CI columns. Expected &#39;lower.CL&#39; or &#39;asymp.LCL&#39;, but columns are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">,</span> <span class="n">confs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Resort columns</span>
        <span class="n">effect_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">sortme</span> <span class="o">=</span> <span class="n">effect_names</span> <span class="o">+</span> <span class="n">sorted_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">[</span><span class="n">sortme</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">[</span><span class="s2">&quot;Sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">[</span><span class="s2">&quot;P-val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">_sig_stars</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">summarize</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">p_adjust</span> <span class="o">==</span> <span class="s2">&quot;tukey&quot;</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;P-values adjusted by tukey method for family of </span><span class="si">{}</span><span class="s2"> estimates&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">[</span><span class="s2">&quot;Contrast&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">p_adjust</span> <span class="o">!=</span> <span class="s2">&quot;tukey&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;P-values adjusted by </span><span class="si">{}</span><span class="s2"> method for </span><span class="si">{}</span><span class="s2"> comparisons&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">p_adjust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">[</span><span class="s2">&quot;Contrast&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lmer.plot_summary"><a class="viewcode-back" href="../../../api.html#pymer4.models.Lmer.plot_summary">[docs]</a>    <span class="k">def</span> <span class="nf">plot_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">error_bars</span><span class="o">=</span><span class="s2">&quot;ci&quot;</span><span class="p">,</span>
        <span class="n">ranef</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">axlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">plot_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ranef_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">coef_fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span>
        <span class="n">ranef_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a forestplot overlaying estimated coefficients with random effects (i.e. BLUPs). By default display the 95% confidence intervals computed during fitting.</span>

<span class="sd">        Args:</span>
<span class="sd">            error_bars (str): one of &#39;ci&#39; or &#39;se&#39; to change which error bars are plotted; default &#39;ci&#39;</span>
<span class="sd">            ranef (bool): overlay BLUP estimates on figure; default True</span>
<span class="sd">            axlim (tuple): lower and upper limit of plot; default min and max of BLUPs</span>
<span class="sd">            plot_intercept (bool): plot the intercept estimate; default True</span>
<span class="sd">            ranef_alpha (float): opacity of random effect points; default .5</span>
<span class="sd">            coef_fmt (str): matplotlib marker style for population coefficients</span>
<span class="sd">            ranef_idx (int): if multiple random effects clusters were specified this value indicates which one should be plotted; uses 0-based indexing; default 0 (first)</span>

<span class="sd">        Returns:</span>
<span class="sd">            plt.axis: matplotlib axis handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model must be fit before plotting!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;orientation must be &#39;h&#39; or &#39;v&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">m_ranef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="p">[</span><span class="n">ranef_idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m_ranef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span>
        <span class="n">m_fixef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_intercept</span><span class="p">:</span>
            <span class="n">m_ranef</span> <span class="o">=</span> <span class="n">m_ranef</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">m_fixef</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">error_bars</span> <span class="o">==</span> <span class="s2">&quot;ci&quot;</span><span class="p">:</span>
            <span class="n">col_lb</span> <span class="o">=</span> <span class="p">(</span><span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;2.5_ci&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
            <span class="n">col_ub</span> <span class="o">=</span> <span class="p">(</span><span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;97.5_ci&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
        <span class="k">elif</span> <span class="n">error_bars</span> <span class="o">==</span> <span class="s2">&quot;se&quot;</span><span class="p">:</span>
            <span class="n">col_lb</span><span class="p">,</span> <span class="n">col_ub</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;SE&quot;</span><span class="p">],</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;SE&quot;</span><span class="p">]</span>

        <span class="c1"># For seaborn</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">m_ranef</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ranef</span><span class="p">:</span>
            <span class="n">alpha_plot</span> <span class="o">=</span> <span class="n">ranef_alpha</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha_plot</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">orient</span> <span class="o">==</span> <span class="s2">&quot;v&quot;</span><span class="p">:</span>
            <span class="n">x_strip</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span>
            <span class="n">x_err</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">]</span>
            <span class="n">y_strip</span> <span class="o">=</span> <span class="s2">&quot;variable&quot;</span>
            <span class="n">y_err</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">m_fixef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_lb</span><span class="p">,</span> <span class="n">col_ub</span><span class="p">]</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">axlim</span><span class="p">:</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="n">axlim</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_strip</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span>
            <span class="n">y_err</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">]</span>
            <span class="n">x_strip</span> <span class="o">=</span> <span class="s2">&quot;variable&quot;</span>
            <span class="n">x_err</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">m_fixef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_lb</span><span class="p">,</span> <span class="n">col_ub</span><span class="p">]</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
                <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">axlim</span><span class="p">:</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="n">axlim</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_strip</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_strip</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_plot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_err</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_err</span><span class="p">,</span>
            <span class="n">xerr</span><span class="o">=</span><span class="n">xerr</span><span class="p">,</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="n">coef_fmt</span><span class="p">,</span>
            <span class="n">capsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">elinewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">ms</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">9999999999</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="Lmer.plot"><a class="viewcode-back" href="../../../api.html#pymer4.models.Lmer.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">param</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">plot_fixef</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">plot_ci</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">grps</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot random and group level parameters from a fitted model</span>

<span class="sd">        Args:</span>
<span class="sd">            param (str): model parameter (column name) to plot</span>
<span class="sd">            figsize (tup): matplotlib desired figsize</span>
<span class="sd">            xlabel (str): x-axis label</span>
<span class="sd">            ylabel (str): y-axis label</span>
<span class="sd">            plot_fixef (bool): plot population effect fit of param?; default True</span>
<span class="sd">            plot_ci (bool): plot computed ci&#39;s of population effect?; default True</span>
<span class="sd">            grps (list): plot specific group fits only; must correspond to index values in model.fixef</span>
<span class="sd">            ax (matplotlib.axes.Axes): axis handle for an existing plot; if provided will ensure that random parameter plots appear *behind* all other plot objects.</span>

<span class="sd">        Returns:</span>
<span class="sd">            plt.axis: matplotlib axis handle</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model must be fit before plotting!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Plotting can currently only handle models with continuous predictors!&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ranef</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Plotting can currently only handle models with 1 random effect grouping variable!&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No fixed effects were estimated so prediction is not possible!&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="c1"># Get range of unique values for desired parameter</span>
        <span class="n">x_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="c1"># Sort order to handle bug in matplotlib plotting</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>

        <span class="c1"># Get desired parameter part of the prediction</span>
        <span class="n">fixef_pred</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">param</span><span class="p">,</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_vals</span>
        <span class="p">)</span>
        <span class="n">fixef_pred_upper</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">param</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_vals</span>
        <span class="p">)</span>
        <span class="n">fixef_pred_lower</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">param</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_vals</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">grps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grps</span><span class="p">):</span>
                <span class="n">ran_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">grps</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grps</span><span class="p">):</span>
                <span class="n">ran_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grps</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;grps must be integer list for integer-indexing (.iloc) of fixed effects, or label list for label-indexing (.loc) of fixed effects&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ran_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span>

        <span class="c1"># Now generate random effects predictions</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ran_dat</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="n">ranef_desired</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_vals</span>
            <span class="c1"># ranef_other = np.dot(other_vals_means, row.loc[other_vals])</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">ranef_desired</span>  <span class="c1"># + ranef_other</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">pred</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_fixef</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">fixef_pred</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">9999999</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_ci</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">fixef_pred_lower</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">fixef_pred_upper</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">9999998</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
            <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">x_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">param</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">xlabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="Lmer.confint"><a class="viewcode-back" href="../../../api.html#pymer4.models.Lmer.confint">[docs]</a>    <span class="k">def</span> <span class="nf">confint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;Wald&quot;</span><span class="p">,</span>
        <span class="n">zeta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nsim</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">boot_type</span><span class="o">=</span><span class="s2">&quot;perc&quot;</span><span class="p">,</span>
        <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">oldnames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute confidence intervals on the parameters of a Lmer object (this is a wrapper for confint.merMod in lme4).</span>
<span class="sd">        Args:</span>
<span class="sd">            self (Lmer): the Lmer object for which confidence intervals should be computed</span>
<span class="sd">            parm (list of str): parameter names for which intervals are sought. Specified by an integer vector of positions</span>
<span class="sd">             (leave blank to compute ci for all parameters)</span>
<span class="sd">            level (float):  confidence level &lt;1, typically above 0.90</span>
<span class="sd">            method (str): which method to compute confidence intervals; &#39;profile&#39;, &#39;Wald&#39; (default), or &#39;boot&#39;</span>
<span class="sd">             (parametric bootstrap)</span>
<span class="sd">            zeta (float): (for method = &quot;profile&quot; only:) likelihood cutoff (if not specified, as by default, computed</span>
<span class="sd">             from level in R).</span>
<span class="sd">            nsim (int): number of bootstrap intervals if bootstrapped confidence intervals are requests; default 500</span>
<span class="sd">            boot_type (str): bootstrap confidence interval type (one of &quot;perc&quot;,&quot;basic&quot;,&quot;norm&quot;, as defined in boot_ci in R)</span>
<span class="sd">            quiet (bool): (logical) suppress messages about computationally intensive profiling?</span>
<span class="sd">            oldnames: (logical) use old-style names for variance-covariance parameters, e.g. &quot;.sig01&quot;, rather than newer</span>
<span class="sd">             (more informative) names such as &quot;sd_(Intercept)|Subject&quot;?</span>
<span class="sd">            seed (int): seed to be passed to bootMer for repeatability.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: confidence intervals for the parameters of interest</span>

<span class="sd">        Examples:</span>
<span class="sd">            The following examples demonstrate how to get different types of confidence intervals.</span>

<span class="sd">            The default Wald estimates for all parameters</span>

<span class="sd">            &gt;&gt;&gt; model.confint()</span>

<span class="sd">            Boostrap estimate for the variance component of the random intercept from factor &quot;Group&quot; and the error</span>
<span class="sd">            variance. You will need more than 100 repeats for a real application</span>

<span class="sd">            &gt;&gt;&gt; model.confint(method=&quot;boot&quot;, nsim=100, parm=[&quot;sd_(Intercept)|Group&quot;,&quot;sigma&quot;])</span>

<span class="sd">            Same as above but using oldnames for those variances, which is still the devault in lme4</span>

<span class="sd">            &gt;&gt;&gt; model.confint(method=&quot;boot&quot;, nsim=100, oldnames=True, parm=[&quot;.sig01&quot;,&quot;.sigma&quot;])</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># record messages going to screen</span>
        <span class="n">r_console</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">r_console</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">callbacks</span><span class="o">.</span><span class="n">consolewrite_warnerror</span> <span class="o">=</span> <span class="n">_f</span>
        <span class="c1"># create string for parm</span>
        <span class="n">parm_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parm_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;,parm=c(&#39;&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">this_parm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parm</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">parm_string</span> <span class="o">=</span> <span class="n">parm_string</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,&#39;&quot;&quot;&quot;</span>
                <span class="n">parm_string</span> <span class="o">=</span> <span class="n">parm_string</span> <span class="o">+</span> <span class="n">this_parm</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;&quot;&quot;&quot;</span>
            <span class="n">parm_string</span> <span class="o">=</span> <span class="n">parm_string</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;)&quot;&quot;&quot;</span>
        <span class="c1"># create string of command</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                function(model){</span>
<span class="sd">                out_ci &lt;- as.data.frame(confint(model&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="n">parm_string</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,level=&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,method=&#39;&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="n">method</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="p">((</span><span class="s2">&quot;&quot;&quot;,zeta=&quot;&quot;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">zeta</span><span class="p">))</span> <span class="k">if</span> <span class="n">zeta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">((</span><span class="s2">&quot;&quot;&quot;,seed=&quot;&quot;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span> <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,nsim=&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nsim</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,boot.type=&#39;&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="n">boot_type</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,quiet=&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;&quot;&quot;TRUE&quot;&quot;&quot;</span> <span class="k">if</span> <span class="n">quiet</span> <span class="k">else</span> <span class="s2">&quot;&quot;&quot;FALSE&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,oldNames=&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;&quot;&quot;TRUE&quot;&quot;&quot;</span> <span class="k">if</span> <span class="n">oldnames</span> <span class="k">else</span> <span class="s2">&quot;&quot;&quot;FALSE&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;))</span>
<span class="s2">            out_ci</span>
<span class="s2">            }&quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">confint_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">out_summary</span> <span class="o">=</span> <span class="n">confint_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="n">out_summary</span> <span class="o">=</span> <span class="n">R2pandas</span><span class="p">(</span><span class="n">out_summary</span><span class="p">)</span>

        <span class="c1"># restore outputs</span>
        <span class="n">callbacks</span><span class="o">.</span><span class="n">consolewrite_warnerror</span> <span class="o">=</span> <span class="n">consolewrite_warning_backup</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">r_console</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_summary</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017-2024, Eshin Jolly.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.1.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>